- name: "Diff config"
  hosts: ios
  connection: network_cli
  gather_facts: no

  vars:
    diff_repo: ssh://git@github.com/victorock/network-configs
    diff_branch: "snapshot"

  handlers:
    - name: "Out-of-Sync"
      fail:
        msg: "/!\\ Configuration is out-of-sync /!\\"

  tasks:

    - name: "create temporary directory to store configuration"
      run_once: true
      changed_when: false
      tempfile:
        state: directory
        suffix: ios_config
      register: r_tempfile

    - name: "clone the repository containing configurations"
      run_once: true
      changed_when: false
      git:
        accept_hostkey: true
        repo: "{{ diff_repo }}"
        dest: "{{ r_tempfile.path }}"
        version: "{{ diff_branch }}"
        clone: yes

    - name: "check diff against configuration from repo"
      check_mode: true
      diff_mode: true
      ios_config:
        diff_against: "intended"
        intended_config: "{{ lookup('file', '{{ r_tempfile.path }}/{{ inventory_hostname }}/config/running.cfg') }}"
        diff_ignore_lines:
          - '^(Current|Building) configuration.*'
          - '^\!.*'
      notify: out_of_sync

    - name: "Cleanup generated files/directories"
      run_once: true
      changed_when: false
      file:
        path: "{{ r_tempfile.path }}"
        state: absent